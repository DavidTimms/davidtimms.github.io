<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Effective.ts Tutorial - Part One" /><meta name="author" content="David Timms" /><meta property="og:locale" content="en" /><meta name="description" content="Effective.ts is a library I recently released, which aims to make it easier to write safe, concurrent, fault-tolerant programs in TypeScript. It takes heavy inspiration from the way side effects are handled in pure functional systems like Haskell and Cats Effect (Scala). This tutorial introduces some of the basic concepts and unique features of the library." /><meta property="og:description" content="Effective.ts is a library I recently released, which aims to make it easier to write safe, concurrent, fault-tolerant programs in TypeScript. It takes heavy inspiration from the way side effects are handled in pure functional systems like Haskell and Cats Effect (Scala). This tutorial introduces some of the basic concepts and unique features of the library." /><link rel="canonical" href="https://davidtimms.github.io/typescript/effective.ts/2021/12/23/effective-ts-tutorial-part-one.html" /><meta property="og:url" content="https://davidtimms.github.io/typescript/effective.ts/2021/12/23/effective-ts-tutorial-part-one.html" /><meta property="og:site_name" content="David Timms" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-23T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Effective.ts Tutorial - Part One" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@David Timms" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Effective.ts is a library I recently released, which aims to make it easier to write safe, concurrent, fault-tolerant programs in TypeScript. It takes heavy inspiration from the way side effects are handled in pure functional systems like Haskell and Cats Effect (Scala). This tutorial introduces some of the basic concepts and unique features of the library.","url":"https://davidtimms.github.io/typescript/effective.ts/2021/12/23/effective-ts-tutorial-part-one.html","@type":"BlogPosting","headline":"Effective.ts Tutorial - Part One","dateModified":"2021-12-23T00:00:00+00:00","datePublished":"2021-12-23T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://davidtimms.github.io/typescript/effective.ts/2021/12/23/effective-ts-tutorial-part-one.html"},"author":{"@type":"Person","name":"David Timms"},"@context":"https://schema.org"}</script><title>Effective.ts Tutorial - Part One | David Timms</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="David Timms"><meta name="application-name" content="David Timms"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">David Timms</a></div><div class="site-subtitle font-italic">Thoughts on code</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Effective.ts Tutorial - Part One</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Effective.ts Tutorial - Part One</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> David Timms </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 23, 2021, 12:00 AM +0000" >Dec 23, 2021<i class="unloaded">2021-12-23T00:00:00+00:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1295 words">7 min read</span></div></div><div class="post-content"><p><a href="https://github.com/DavidTimms/effective.ts">Effective.ts</a> is a library I recently released, which aims to make it easier to write safe, concurrent, fault-tolerant programs in TypeScript. It takes heavy inspiration from the way side effects are handled in pure functional systems like <a href="https://en.wikibooks.org/wiki/Haskell/Understanding_monads/IO">Haskell</a> and <a href="https://typelevel.org/cats-effect/">Cats Effect (Scala)</a>. This tutorial introduces some of the basic concepts and unique features of the library.</p><h2 id="introducing-io">Introducing IO</h2><p>The most important concept in the library is a type called <code class="language-plaintext highlighter-rouge">IO</code>. An <code class="language-plaintext highlighter-rouge">IO</code> is an action - a fragment of a program. When it is run, it can perform side effects, like writing to disk or making HTTP requests. It is a thin wrapper around an asynchronous function, which is why it returns a promise when it is run.</p><p>The best way to write programs with effective.ts is to combine these small fragments of programs together into larger more complex actions, until you have a single <code class="language-plaintext highlighter-rouge">IO</code> which represents your entire program. That means you only need one call to <code class="language-plaintext highlighter-rouge">.run()</code> which comes at very top level of the program.</p><p>At this stage, it might seem like unnecessary indirection to create an <code class="language-plaintext highlighter-rouge">IO</code> then run in later in the program, but this separation gives us much more power to manipulate the control flow of our program, as we will see in part two.</p><p>The <code class="language-plaintext highlighter-rouge">IO</code> type has two type parameters:</p><ul><li><code class="language-plaintext highlighter-rouge">A</code> is the type of values returned when the action succeeds.<li><code class="language-plaintext highlighter-rouge">E</code> is the type of errors raised when the action fails. For now, we can omit this, and let it default to <code class="language-plaintext highlighter-rouge">unknown</code>. We’ll see more about handling errors later.</ul><p>Let’s see how we create an <code class="language-plaintext highlighter-rouge">IO</code>.</p><p>To get started we need to import <code class="language-plaintext highlighter-rouge">IO</code>:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">IO</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">effective.ts</span><span class="dl">'</span><span class="p">;</span> </code></div></div><p>The simplest way is using <a href="https://davidtimms.github.io/effective.ts/modules/io.IO.html#wrap"><code class="language-plaintext highlighter-rouge">IO.wrap</code></a>. This creates an action which will return a specific value when it is run. The action always succeeds and does not perform any side effects. Some other libraries call this function <code class="language-plaintext highlighter-rouge">pure</code> or <code class="language-plaintext highlighter-rouge">return</code>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">const</span> <span class="nx">return123</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span> <span class="nx">return123</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> <span class="c1">// return a promise which resolves to 123.</span> </code></div></div><p>That’s all well and good, but we want to perform side effects! For that we need to use <a href="https://davidtimms.github.io/effective.ts/modules/io.html#IO-2">the <code class="language-plaintext highlighter-rouge">IO</code> function</a>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">const</span> <span class="nx">printHi</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hi!</span><span class="dl">"</span><span class="p">));</span> <span class="nx">printHi</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> <span class="c1">// prints "Hi!" to the console.</span> </code></div></div><p>In the above example, <code class="language-plaintext highlighter-rouge">console.log</code> does not return any useful value, so the result type for the action is <code class="language-plaintext highlighter-rouge">void</code>.</p><p>We can also create actions which perform asynchronous effects, such as network requests.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="k">import</span> <span class="nx">fetch</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">node-fetch</span><span class="dl">"</span><span class="p">;</span> <span class="kd">const</span> <span class="nx">makeRequest</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="nx">Response</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.wikipedia.org</span><span class="dl">"</span><span class="p">));</span> <span class="c1">// returns promise which resolves to a Response</span> <span class="c1">// object once the request is complete.</span> <span class="nx">makeRequest</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> </code></div></div><p>Notice that the type of <code class="language-plaintext highlighter-rouge">makeRequest</code> is <code class="language-plaintext highlighter-rouge">IO&lt;Response&gt;</code>, not <code class="language-plaintext highlighter-rouge">IO&lt;Promise&lt;Response&gt;&gt;</code>? That demonstrates something important - all actions in effective.ts are implicitly asynchronous, so the types do not distinguish between synchronous and asynchronous. You shouldn’t need to use <code class="language-plaintext highlighter-rouge">async</code> and <code class="language-plaintext highlighter-rouge">await</code> at all, or deal with promises directly. Asynchronous actions are awaited automatically by the runtime.</p><h2 id="combining-actions">Combining Actions</h2><p>Now that we know how to build a basic action, how do we go about combining these into full programs? <code class="language-plaintext highlighter-rouge">IO</code> has a few methods to help.</p><p><a href="https://davidtimms.github.io/effective.ts/classes/io.IOBase.html#map">The <code class="language-plaintext highlighter-rouge">map</code> method</a> can be used to transform the result of an action using a pure function. It is equivalent to the <code class="language-plaintext highlighter-rouge">map</code> method on an array.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">const</span> <span class="nx">mapped</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="mi">123</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="nx">mapped</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> <span class="c1">// return a promise which resolves to 124.</span> </code></div></div><p><a href="https://davidtimms.github.io/effective.ts/classes/io.IOBase.html#andThen">The <code class="language-plaintext highlighter-rouge">andThen</code> method</a> is used to perform one action after another. The function which produces the second action takes the result of the first action as an argument. This function is sometimes also called <code class="language-plaintext highlighter-rouge">flatMap</code> or <code class="language-plaintext highlighter-rouge">bind</code>. It is what makes the <code class="language-plaintext highlighter-rouge">IO</code> type a monad.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="k">import</span> <span class="nx">fetch</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">node-fetch</span><span class="dl">"</span><span class="p">;</span> <span class="kd">const</span> <span class="nx">fetchWikipediaHomepage</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.wikipedia.org</span><span class="dl">"</span><span class="p">))</span> <span class="p">.</span><span class="nx">andThen</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">()))</span> <span class="c1">// returns promise which resolves with the text of the response.</span> <span class="nx">fetchWikipediaHomepage</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> </code></div></div><p>These features alone are enough to build up many programs. But in the real world, nothing ever goes quite to plan. It’s time to look at how we can handle those pesky errors.</p><h2 id="handling-errors">Handling Errors</h2><p>The standard way of dealing with errors in TypeScript is to throw an exception, then catch it with a <code class="language-plaintext highlighter-rouge">try/catch</code> block. While this does work, it has a few problems. It is hard to maintain type safety in <code class="language-plaintext highlighter-rouge">catch</code> blocks, because the compiler does not know what kinds of exception can be thrown. That is why TypeScript uses the rather unhelpful <code class="language-plaintext highlighter-rouge">any</code> or <code class="language-plaintext highlighter-rouge">unknown</code> types for caught exceptions.</p><p>The second problem comes when you call a library function. As a user of the library, it is hard to know what kinds of exceptions the function might throw. If you are lucky, this information will be described in the library documentation, and if you are <em>very</em> lucky, the description will be up-to-date!</p><p>In effective.ts, you can “raise” an error, which is equivalent to throwing an exception. The difference is that the <code class="language-plaintext highlighter-rouge">IO</code> type describes in its second type parameter what types of error the action can possibly raise. This helps to make functions self-documenting.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="c1">// Because the error type is "never", we know this</span> <span class="c1">// action will never raise an error.</span> <span class="kd">const</span> <span class="nx">neverFails</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="kr">number</span><span class="p">,</span> <span class="nx">never</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="mi">456</span><span class="p">);</span> </code></div></div><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">const</span> <span class="nx">alwaysFails</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="nx">never</span><span class="p">,</span> <span class="nx">TypeError</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">raise</span><span class="p">(</span><span class="nx">TypeError</span><span class="p">(</span><span class="dl">"</span><span class="s2">validation failed</span><span class="dl">"</span><span class="p">));</span> <span class="c1">// Returns a promise which rejects with the TypeError.</span> <span class="nx">alwaysFails</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> </code></div></div><p>As we saw earlier, when we want to call outside code with side effects, we need to wrap the call in <code class="language-plaintext highlighter-rouge">IO</code>. This includes any code which might throw an exception. When we run the action, it will catch any exceptions which are thrown and raise them in the <code class="language-plaintext highlighter-rouge">IO</code> context. Since we cannot know what exceptions third-party code might throw, the error type this case defaults to <code class="language-plaintext highlighter-rouge">unknown</code>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">const</span> <span class="nx">printGreeting</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="k">void</span><span class="p">,</span> <span class="nx">unknown</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Greetings!</span><span class="dl">"</span><span class="p">));</span> </code></div></div><p>If you do not care about precise tracking of errors, you can leave them typed as <code class="language-plaintext highlighter-rouge">unknown</code> throughout the program. If you do want precision though, you can convert the unknown error to a known type. You can do this with <a href="https://davidtimms.github.io/effective.ts/classes/io.IOBase.html#mapError">the <code class="language-plaintext highlighter-rouge">mapError</code> method</a>, which is the calamitous cousin of the <code class="language-plaintext highlighter-rouge">map</code> method we used previously - it transforms an error using a pure function. If the action does not raise an error, the transformer function is never called.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">class</span> <span class="nx">PrintingError</span> <span class="kd">extends</span> <span class="nb">Error</span> <span class="p">{</span> <span class="kd">constructor</span><span class="p">(</span><span class="k">readonly</span> <span class="nx">cause</span><span class="p">:</span> <span class="nx">unknown</span><span class="p">)</span> <span class="p">{</span> <span class="k">super</span><span class="p">(</span><span class="s2">`Failed to print to console: </span><span class="p">${</span><span class="nx">cause</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span> <span class="kd">const</span> <span class="nx">knownError</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="k">void</span><span class="p">,</span> <span class="nx">PrintingError</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">printGreeting</span><span class="p">.</span><span class="nx">mapError</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">PrintingError</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span> </code></div></div><p>If we want to recover from an error instead of just transforming it, we need <a href="https://davidtimms.github.io/effective.ts/classes/io.IOBase.html#catch">the <code class="language-plaintext highlighter-rouge">catch</code> method</a>. The catcher function returns an action, so it can use <code class="language-plaintext highlighter-rouge">IO.raise</code> to re-raise an error or <code class="language-plaintext highlighter-rouge">IO.wrap</code> to return a fallback value.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="k">import</span> <span class="nx">fetch</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">node-fetch</span><span class="dl">"</span><span class="p">;</span> <span class="kd">const</span> <span class="nx">fetchWithCatch</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">never</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.wikipedia.org</span><span class="dl">"</span><span class="p">))</span> <span class="p">.</span><span class="nx">map</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">fetched successfully</span><span class="dl">"</span><span class="p">)</span> <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="dl">"</span><span class="s2">failed to fetch</span><span class="dl">"</span><span class="p">));</span> <span class="c1">// returns a promise which resolves with</span> <span class="c1">// "fetched successfully" or "failed to fetch".</span> <span class="nx">fetchWithCatch</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span> </code></div></div><p>In the example above, we can see that the error type for the entire <code class="language-plaintext highlighter-rouge">fetchWithCatch</code> action is <code class="language-plaintext highlighter-rouge">never</code>, meaning it will never raise an error. This is inferred because we caught any errors and did not re-raise them.</p><p>When programming with effective.ts, it is important to use <code class="language-plaintext highlighter-rouge">IO.raise</code> instead of throwing exceptions directly, otherwise the types of the errors will not be tracked correctly.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span text-data=" TypeScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="kd">const</span> <span class="nx">unsafelyThrow</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="nx">Response</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.wikipedia.org</span><span class="dl">"</span><span class="p">))</span> <span class="p">.</span><span class="nx">andThen</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// BAD</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Request failed</span><span class="dl">"</span><span class="p">);</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span> <span class="kd">const</span> <span class="nx">safelyRaise</span><span class="p">:</span> <span class="nx">IO</span><span class="o">&lt;</span><span class="nx">Response</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">IO</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.wikipedia.org</span><span class="dl">"</span><span class="p">))</span> <span class="p">.</span><span class="nx">andThen</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// GOOD</span> <span class="k">return</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">raise</span><span class="p">(</span><span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Request failed</span><span class="dl">"</span><span class="p">))</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">IO</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span> <span class="p">}</span> <span class="p">});</span> </code></div></div><hr /><p>We’ve now covered the basics of effective.ts. We can use <code class="language-plaintext highlighter-rouge">IO</code> to represent actions and combine these actions into full programs with error handling.</p><p>In part two, we’ll dive in to what really makes the library special - its support for concurrency, fault-tolerance and cancellation.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/typescript/'>typescript</a>, <a href='/categories/effective-ts/'>effective.ts</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/programming-languages/typescript/2020/11/20/exploring-template-literal-types-in-typescript-4.1.html"><div class="card-body"> <span class="timeago small" >Nov 20, 2020<i class="unloaded">2020-11-20T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Exploring Template Literal Types in TypeScript 4.1</h3><div class="text-muted small"><p> TypeScript 4.1 has just been released. This edition of the language builds on the features introduced in version 4.0 with a group of new tools which provide typesafe ways to express common dynamic ...</p></div></div></a></div><div class="card"> <a href="/programming-languages/ocaml/2022/01/19/seven-days-of-ocaml.html"><div class="card-body"> <span class="timeago small" >Jan 19<i class="unloaded">2022-01-19T00:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Seven Days of OCaml</h3><div class="text-muted small"><p> A few weeks ago, I returned from an ill-advised excursion to London to discover that I had picked up COVID-19. Whoops. Luckily my symptoms were very mild, but I still had to remain in self-isolatio...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/programming-languages/typescript/2020/11/20/exploring-template-literal-types-in-typescript-4.1.html" class="btn btn-outline-primary" prompt="Older"><p>Exploring Template Literal Types in TypeScript 4.1</p></a> <a href="/programming-languages/ocaml/2022/01/19/seven-days-of-ocaml.html" class="btn btn-outline-primary" prompt="Newer"><p>Seven Days of OCaml</p></a></div></div></div></div><footer class="site-footer h-card"> <data class="u-url" href="/"></data><div class="wrapper"><div class="footer-col-wrapper"><div class="footer-col footer-col-1"><ul class="contact-list"><li class="p-name">© 2022 David Timms</ul></div><div class="footer-col footer-col-2" style="text-align: right;"></div></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Do forgive me! No result could be found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
